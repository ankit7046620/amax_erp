 name: Flutter CI

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      # No spaces in email list!
      RECIPIENT_EMAILS: vpprajapati19@gmail.com,sharmapratik151994@gmail.com

    steps:
      - name: ‚úÖ Checkout code
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Get Flutter version
        run: |
          if [ -f ".flutter-version" ]; then
            FLUTTER_VERSION=$(cat .flutter-version)
          else
            FLUTTER_VERSION=$(grep 'flutter:' pubspec.yaml | awk '{print $2}' | tr -d '"')
          fi
          echo "FLUTTER_VERSION=$FLUTTER_VERSION" >> $GITHUB_ENV

      - name: üöÄ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: üì¶ Install dependencies
        run: flutter pub get

      - name: üîç Analyze code
        run: flutter analyze || true

      - name: üèóÔ∏è Build APK
        run: flutter build apk --release --split-per-abi --obfuscate --split-debug-info=build/debug_info

      - name: üìù Rename APK with current date
        run: |
          DATE=$(date +'%Y-%m-%d')
          ORIG_APK=build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
          RENAMED_APK=build/app/outputs/flutter-apk/demo-app-${DATE}.apk
          mv "$ORIG_APK" "$RENAMED_APK"
          echo "APK_NAME=demo-app-${DATE}.apk" >> $GITHUB_ENV
          echo "APK_PATH=$RENAMED_APK" >> $GITHUB_ENV

      - name: üì• Install rclone
        run: curl https://rclone.org/install.sh | sudo bash

      - name: ‚öôÔ∏è Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf

      - name: ‚òÅÔ∏è Upload APK to Google Drive folder
        run: |
          if rclone ls "gdrive:" > /dev/null 2>&1; then
            rclone copy "$APK_PATH" "gdrive:1vIXs8HlKygEoYRt7-qD9zvpG9-E75kNk"
            echo "DOWNLOAD_LINK=https://drive.google.com/drive/folders/1vIXs8HlKygEoYRt7-qD9zvpG9-E75kNk" >> $GITHUB_ENV
          else
            echo "‚ùå ERROR: gdrive remote not found in rclone config"
            exit 1
          fi

      - name: üìß Send Email with APK Link
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üöÄ Demo App APK - ${{ env.APK_NAME }}"
          to: ${{ env.RECIPIENT_EMAILS }}
          from: "Flutter Bot <${{ secrets.EMAIL_USERNAME }}>"
          content_type: text/html
          body: |
            <p>Hello,</p>
            <p>The Amax ERP system is ready for download.</p>
            <p>If you find any bugs, please ping me on WhatsApp at <strong>8460624920</strong>.</p>
            <p>Email: <a href="mailto:patelankit70466@gmail.com">patelankit70466@gmail.com</a></p>
            <p><strong>Download APK here:</strong> <a href="${{ env.DOWNLOAD_LINK }}">Click to download</a></p>
